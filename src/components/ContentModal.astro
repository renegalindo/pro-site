---
import type { CollectionEntry } from 'astro:content';

interface Props {
  project: CollectionEntry<'work'>;
  returnPath?: string;
}

const { project, returnPath = '/work' } = Astro.props;
const { Content } = await project.render();
---

<!-- Modal Backdrop -->
<div
  id="modal-backdrop"
  class="fixed inset-0 bg-black/40 z-[100]"
  aria-hidden="true"
  data-return-path={returnPath}
  transition:name="modal-backdrop"
  transition:animate="fade"
>
</div>

<!-- Modal Container -->
<div
  id="modal-container"
  class="fixed inset-0 z-[110] flex items-center justify-center pointer-events-none p-4"
  role="dialog"
  aria-modal="true"
  aria-labelledby="modal-title"
>
  <!-- Modal Card -->
  <div
    id="modal-card"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden pointer-events-auto"
    transition:name="modal-card"
  >
    <!-- Close Button Header -->
    <div class="sticky top-0 z-10 bg-white border-b border-gray-100">
      <div class="flex items-center justify-end px-6 py-4">
        <a
          href={returnPath}
          id="modal-close"
          class="text-gray-400 hover:text-gray-600 transition-colors"
          aria-label="Close modal"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </a>
      </div>
    </div>

    <!-- Scrollable Content Area -->
    <div class="overflow-y-auto max-h-[calc(85vh-64px)] px-6 py-8">
      <header class="space-y-4 mb-8">
        <h1 id="modal-title" class="text-2xl font-medium text-gray-900">
          {project.data.title}
        </h1>
        {(project.data.company || project.data.role || project.data.year) && (
          <p class="text-gray-500">
            {project.data.company && <span>{project.data.company}</span>}
            {project.data.company && project.data.role && <span> · </span>}
            {project.data.role && <span>{project.data.role}</span>}
            {(project.data.company || project.data.role) && project.data.year && <span> · </span>}
            {project.data.year && <span>{project.data.year}</span>}
          </p>
        )}
      </header>

      <article class="prose">
        <Content />
      </article>
    </div>
  </div>
</div>

<style>
  .prose {
    @apply text-gray-700 leading-relaxed;
  }

  .prose :global(h2) {
    @apply text-xl font-medium text-gray-900 mt-8 mb-4;
  }

  .prose :global(h3) {
    @apply text-lg font-medium text-gray-900 mt-6 mb-3;
  }

  .prose :global(p) {
    @apply mb-4;
  }

  .prose :global(ul) {
    @apply list-disc pl-6 mb-4;
  }

  .prose :global(li) {
    @apply mb-2;
  }

  .prose :global(a) {
    @apply underline hover:text-gray-600;
  }
</style>

<script>
  function setupModalHandlers() {
    const backdrop = document.getElementById('modal-backdrop');
    const closeButton = document.getElementById('modal-close');
    const modalCard = document.getElementById('modal-card');

    if (!backdrop || !closeButton || !modalCard) return;

    const returnPath = backdrop.dataset.returnPath || '/work';

    const closeModal = () => {
      window.location.href = returnPath;
    };

    // Get focusable elements for focus trap
    const focusableElements = modalCard.querySelectorAll(
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    );
    const firstFocusable = focusableElements[0] as HTMLElement;
    const lastFocusable = focusableElements[focusableElements.length - 1] as HTMLElement;

    // Single keyboard handler for Escape and focus trap
    const handleKeydown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        closeModal();
        return;
      }

      // Focus trap
      if (e.key === 'Tab' && firstFocusable) {
        if (e.shiftKey && document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable?.focus();
        } else if (!e.shiftKey && document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable.focus();
        }
      }
    };

    // Close on backdrop click
    const handleBackdropClick = (e: MouseEvent) => {
      if (e.target === backdrop) {
        closeModal();
      }
    };

    // Close on close button click
    const handleCloseClick = (e: MouseEvent) => {
      e.preventDefault();
      closeModal();
    };

    // Add listeners
    document.addEventListener('keydown', handleKeydown);
    backdrop.addEventListener('click', handleBackdropClick);
    closeButton.addEventListener('click', handleCloseClick);

    // Focus close button on open
    setTimeout(() => closeButton.focus(), 100);

    // Cleanup all listeners on navigation
    document.addEventListener('astro:before-preparation', () => {
      document.removeEventListener('keydown', handleKeydown);
      backdrop.removeEventListener('click', handleBackdropClick);
      closeButton.removeEventListener('click', handleCloseClick);
    }, { once: true });
  }

  // Initialize on page load
  document.addEventListener('astro:page-load', setupModalHandlers);
</script>
