---
interface Props {
  hidden?: boolean;
}

const { hidden = false } = Astro.props;

const navLinks = [
  { href: '/', label: 'About' },
  { href: '/work', label: 'Work' },
  { href: '/stack', label: 'Stack' },
  { href: '/now', label: 'Now' },
];

const currentPath = Astro.url.pathname;

// Helper to check if a link matches current path
const isActive = (href: string) =>
  currentPath === href || (href !== '/' && currentPath.startsWith(href));
---

<header class:list={[
  "top-0 z-10 w-full bg-gray-50/70 backdrop-blur-md",
  hidden ? "absolute opacity-0 pointer-events-none" : "sticky"
]}>
  <div class="max-w-2xl mx-auto px-4 pt-12 pb-4">
    <div class="flex items-center gap-6">
      <button id="header-menu-button" class="hover:text-gray-600 transition-colors" aria-label="Toggle menu">
        <img id="header-avatar" src="/avatar.png" alt="RenÃ© Galindo" class="w-10 h-10 rounded-full transition-all duration-200 ease-in-out" />
      </button>

      <nav id="header-dropdown" class="opacity-0 -translate-x-2 pointer-events-none transition-all duration-150 ease-out">
        <ul class="flex items-center gap-6 text-xl">
          {navLinks.map((link) => (
            <li>
              <a
                href={link.href}
                class:list={[
                  'hover:text-gray-600 transition-colors',
                  isActive(link.href) ? 'text-gray-900 font-medium' : 'text-gray-500',
                ]}
              >
                {link.label}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    </div>
  </div>
</header>

<script>
  function setupHeader() {
    const button = document.getElementById('header-menu-button');
    const dropdown = document.getElementById('header-dropdown');
    const avatar = document.getElementById('header-avatar');

    if (!button || !dropdown || !avatar) return;

    const closeDropdown = (keepPosition = false) => {
      dropdown.classList.remove('opacity-100');
      if (!keepPosition) {
        dropdown.classList.remove('translate-x-0');
        dropdown.classList.add('-translate-x-2');
      }
      dropdown.classList.add('opacity-0', 'pointer-events-none');
      avatar.classList.remove('rotate-[20deg]');
    };

    const openDropdown = () => {
      avatar.classList.add('rotate-[20deg]');
      setTimeout(() => {
        dropdown.classList.remove('opacity-0', '-translate-x-2', 'pointer-events-none');
        dropdown.classList.add('opacity-100', 'translate-x-0');
      }, 135);
    };

    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = dropdown.classList.contains('opacity-100');
      isOpen ? closeDropdown() : openDropdown();
    });

    document.addEventListener('click', () => {
      if (dropdown.classList.contains('opacity-100')) {
        closeDropdown();
      }
    });

    dropdown.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target?.tagName === 'A') {
        closeDropdown(true); // Keep position, just fade out
      }
    });
  }

  document.addEventListener('astro:page-load', setupHeader);
</script>
