---
interface Props {
  pageTitle?: string;
}

const { pageTitle } = Astro.props;

const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/work', label: 'Work' },
  { href: '/stack', label: 'Stack' },
];

const currentPath = Astro.url.pathname;

// Filter out current page from dropdown, unless it's home
const dropdownLinks = navLinks.filter(link => {
  if (currentPath === '/') return true; // Show all links on home
  const isCurrentPage = currentPath === link.href || (link.href !== '/' && currentPath.startsWith(link.href));
  return !isCurrentPage; // Hide current page from dropdown
});
---

<header class="sticky top-0 z-10 w-full bg-gray-50">
  <div class="max-w-2xl mx-auto px-4 pt-24 pb-4">
    <div class="flex items-center gap-6">
      <button id="header-menu-button" class="flex items-center gap-4 hover:text-gray-600 transition-colors" aria-label="Toggle menu">
        <img id="header-avatar" src="/avatar.png" alt="RenÃ© Galindo" class="w-10 h-10 rounded-full transition-all duration-200 ease-in-out" />
        {pageTitle && <h1 class="text-lg font-medium text-gray-900 hover:text-gray-900" transition:name="page-title">{pageTitle}</h1>}
      </button>

      <nav id="header-dropdown" class="opacity-0 -translate-x-2 pointer-events-none transition-all duration-150 ease-out">
        <ul class="flex items-center gap-6 text-lg">
          {dropdownLinks.map((link) => (
            <li>
              <a
                href={link.href}
                class:list={[
                  'hover:text-gray-600 transition-colors',
                  currentPath === link.href || (link.href !== '/' && currentPath.startsWith(link.href))
                    ? 'text-gray-900 font-medium'
                    : 'text-gray-500',
                ]}
              >
                {link.label}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    </div>
  </div>
</header>

<script>
  function setupHeader() {
    const button = document.getElementById('header-menu-button');
    const dropdown = document.getElementById('header-dropdown');
    const avatar = document.getElementById('header-avatar');

    if (!button || !dropdown || !avatar) return;

    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = dropdown.classList.contains('opacity-100');

      if (isOpen) {
        // Closing: hide dropdown, rotate back
        dropdown.classList.remove('opacity-100', 'translate-x-0');
        dropdown.classList.add('opacity-0', '-translate-x-2', 'pointer-events-none');
        avatar.classList.remove('rotate-[20deg]');
      } else {
        // Opening: rotate first, then show dropdown after animation completes
        avatar.classList.add('rotate-[20deg]');
        setTimeout(() => {
          dropdown.classList.remove('opacity-0', '-translate-x-2', 'pointer-events-none');
          dropdown.classList.add('opacity-100', 'translate-x-0');
        }, 135);
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      if (dropdown.classList.contains('opacity-100')) {
        dropdown.classList.remove('opacity-100', 'translate-x-0');
        dropdown.classList.add('opacity-0', '-translate-x-2', 'pointer-events-none');
        avatar.classList.remove('rotate-[20deg]');
      }
    });

    // When clicking a link, fade out dropdown in place (no slide)
    dropdown.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target && target.tagName === 'A') {
        // Fade out in place - keep translate-x-0, only change opacity
        dropdown.classList.remove('opacity-100');
        dropdown.classList.add('opacity-0', 'pointer-events-none');
        avatar.classList.remove('rotate-[20deg]');
      }
    });
  }

  // Run on initial load and after each view transition
  document.addEventListener('astro:page-load', setupHeader);
</script>
